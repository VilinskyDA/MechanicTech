# Проект: модульный конструктор оружия/снаряжения + пошаговая тактика

> Документ концепции и технических опорных механик (GDD/Tech Spec). Цель — зафиксировать модель, допущения и контракт данных для реализации валидатора/симулятора и тактического боя.

---

## 1. Короткое описание
Игра про **самостоятельное проектирование оружия, брони и снаряжения** из модулей (помодульно, как конструктор в стиле KSP) и **пошаговые тактические бои**, где проявляются последствия инженерных решений.

Тяжёлые расчёты выполняются **на этапе валидации/подготовки** (оффлайн-симуляция/солверы). В бою используется **быстрый lookup/интерполяция** по предрасчитанным таблицам/профилям.

Проект служит для:
- формирования **документации по механикам**,
- создания **тестового кода** (валидатор, генераторы таблиц, симулятор),
- обеспечения воспроизводимости и удобства баланса.

---

## 2. Видение и целевая аудитория

### 2.1 Фантазия игрока
Игрок — **оружейник-практик (инженер)**, который сам проектирует оружие, броню и снаряжение, а затем **проверяет свои инженерные решения в бою**. Бой — не пассивный просмотр результата сборки: это пространство тактических решений, **границы которого определены тем, что игрок сам себе заложил на этапе конструирования**.

Прямая аналогия — KSP: сборка ракеты определяет, что ты *можешь* сделать в полёте, но полёт требует собственных решений. Здесь сборка определяет возможности в бою, а бой — проверка и инженерии, и тактического мышления.

### 2.2 Момент кайфа
Ключевые эмоции, которые должна создавать игра:
- **«Я это предусмотрел»** — инженерное решение открыло тактическую возможность, которой игрок воспользовался в бою.
- **«Я это не учёл»** — конструкция подвела в неожиданной ситуации, и игрок понимает *почему* и *что изменить*.
- **«Я нашёл хитрую комбинацию»** — нестандартная сборка дала неочевидное преимущество, которое проявилось в бою.

### 2.3 Целевая аудитория
Уровень сложности — **между хардкором и продвинутым**. Ориентир: KSP с модами, Juno: New Origins.
- Физика честная и ощущается — результаты не «магические числа», а следствие реальных параметров.
- UI помогает разобраться: визуализации, подсказки, сравнения, пресеты — но не прячут глубину.
- Игрок, готовый вникать, получает больше контроля и удовольствия.

### 2.4 Сеттинг
**Далёкое будущее, космос.** Фракция игрока пережила технологический откат — начинает с примитивных средств и постепенно восстанавливает (или переоткрывает) технологии.

Это даёт:
- **Нарративное обоснование постепенного раскрытия механик:** от простой кинетики в начале до энергетического оружия, композитной брони, экзоскелетов и экзотики в эндгейме.
- **Естественную прогрессию сложности** без искусственного туториала — игрок осваивает новые системы по мере того, как они становятся доступны по сюжету.
- **Свободу места действия:** планеты, станции, обломки, разнообразные среды — почти без ограничений.

---

## 3. Цели и ограничения
### 3.1 Цели
- **Физически корректный конструктор** в рамках выбранной модели: масса/баланс/нагрузки/нагрев/прочность/совместимость считаются при валидации.
- **Быстрый пошаговый бой**: в бою — только lookup/интерполяция и простые формулы.
- **Детерминизм и тестируемость**: расчёты воспроизводимы, покрываются unit/golden тестами.
- **Расширяемость**: поддержка разных типов вооружения (кинетика/энергетика/ближний бой/гибриды) и защиты через единый контракт данных.

### 3.2 Не-цели (на старте)
- Реалтайм CFD/FEA, детальная многофизика в бою.
- Большая сюжетная кампания/контент-ориентированный проект.

---

## 4. Пиллары
- **Инженерия → последствия**: сборка определяет эффективность и ограничения.
- **Ограничения и совместимость** важнее «лут-статов».
- **Симуляции и тесты** — часть продукта.
- **Сложность допускается**, но объяснение влияния — только там, где корректно; нелинейности помечаются.

---

## 5. Управление сложностью

### 5.1 Принцип: LOD параметров через вкладки
Игрок всегда работает с **реальными числовыми параметрами** (SI) — никаких абстракций вроде «прочность: высокая». Однако параметры блока/модуля организованы по вкладкам с уровнями детализации (LOD). На старте игрок видит только базовую вкладку с ключевыми параметрами (масса, габариты, основная характеристика). По мере роста технологического уровня **открываются новые вкладки и параметры** — каждый с пояснением, за что он отвечает и как влияет на поведение.

Полный аналог подхода Juno: New Origins — игрок обучается параллельно с прогрессией, а не получает все параметры сразу.

### 5.2 Прогрессия через технологический уровень
На низком технологическом уровне доступно мало типов модулей, материалов и каналов угроз — система проста по объёму, не по глубине. С ростом уровня появляются новые материалы, эффекторы, каналы (энергетика, композиты, гибриды) — и вместе с ними открываются соответствующие параметры и вкладки в конструкторе.

### 5.3 Пресеты и шаблоны
Готовые сборки (стандартные конфигурации для текущего техуровня) служат точкой входа. Игрок может использовать пресет как есть или модифицировать, постепенно разбираясь в параметрах.

### 5.4 Визуализации
Числовые параметры дополняются визуальными инструментами: сравнительные графики, тепловые карты нагрузок, цветовая индикация критических зон и запасов прочности. Визуализации не заменяют числа, а помогают быстрее считывать общую картину.

---

## 6. Core loop

### 6.1 Цикл игровой сессии
1) **Сборка** — проектирование оружия/брони/снаряжения из модулей в конструкторе.
2) **Валидация** — проверка сборки + предрасчёт производных параметров и таблиц.
3) **Подготовка** — экипировка бойца/отряда (слоты, масса, боекомплект, энергия).
4) **Пошаговый бой** — тактические решения в рамках возможностей, заложенных сборкой (AP, укрытия, видимость, применение эффекторов).
5) **Пост-бой** — износ/ремонт/расходники, анализ результатов → возврат к сборке с новым пониманием.

### 6.2 Петля мотивации
Цикл работает, когда каждый бой даёт игроку **конкретное понимание**, что в его конструкции сработало, что нет и почему. Это понимание мотивирует вернуться в конструктор не «просто улучшить статы», а решить конкретную инженерную задачу: сменить материал слоя, перекомпоновать модули, выбрать другой калибр под новую угрозу.

С ростом технологического уровня (см. раздел 2.4) появляются новые типы угроз и модулей — старые сборки перестают быть оптимальными, и игрок возвращается в конструктор с новыми вводными.

### 6.3 Обратная связь (три уровня)

**Уровень 1 — Эффекты в бою (мгновенная обратная связь).**
Во время боя игрок видит последствия своих инженерных решений в реальном времени хода: пробитие/рикошет, перегрев, нехватка AP из-за веса, отказ модуля. Это не просто числа — это наблюдаемые события, которые дают интуитивное понимание «работает / не работает» ещё до окончания боя.

**Уровень 2 — Результирующий отчёт (аналитическая обратная связь).**
После боя игрок получает детальный разбор — «чёрный ящик» сражения:
- какие воздействия были нанесены/получены и через какие каналы;
- как отработали слои защиты (пробитие/остановка/рикошет, остаточная энергия);
- тепловой профиль модулей, критические моменты;
- расход AP по действиям, узкие места подвижности;
- какие модули получили износ/повреждения и почему.

Отчёт связывает боевые события с конкретными деталями/модулями сборки, позволяя игроку точно определить, что менять.

**Уровень 3 — Реакция мира (долгосрочная обратная связь).**
*(TBD — проработать позже.)*
Мир реагирует на действия и результаты игрока в долгосрочной перспективе: изменение доступности ресурсов, адаптация противников, репутация, открытие/закрытие возможностей. Этот уровень замыкает мотивацию за пределами одного боя.

---

## 7. Конструктор (KSP-подобная сборка)
### 7.1 Термины
- **Part / Деталь** (в разговоре часто «модуль»): физический объект конструктора. Имеет массу/габариты/материалы, узлы крепления (nodes), ограничения совместимости и набор функциональных компонентов.
- **Component / Поведенческий модуль**: функциональная «начинка» детали (подавление звука, газодинамика, теплоёмкость, сенсоры, питание, и т.д.). Одна деталь может включать несколько компонентов.
- **Role / Роль**: классификация для правил/интерфейса. Одна деталь может иметь несколько ролей.

### 7.2 Базовые роли (для классификации и UI)
- **Структура** (каркас/несущие элементы/крепёж)
- **Эффектор** (источник воздействия: выстрел/луч/удар/взрыв/гибрид)
- **Защита** (снижение воздействия: броня/экраны/демпферы/изоляция)
- **Утилита** (медицинские/инструменты/подсумки/разведка)
- **Энергосистема** (источник/накопитель/распределение)
- **Сенсоры/управление** (оптика/стабилизация/вычислители)
- **Перемещение/поддержка** (разгрузка/экзоскелет/опоры)
- **Адаптер/крепёж** (переходники/планки/интерфейсы)

### 7.3 Узлы и соединения
Деталь предоставляет набор **узлов крепления**: тип интерфейса, ориентация, допустимые соседи/классы крепления, ограничения по допускам.
Сборка — это граф деталей с соединениями по узлам.

### 7.4 Валидация сборки
Валидация выполняет:
- Проверку структурной целостности (обязательные подсистемы, закрытие узлов).
- Проверку совместимости (калибр/питание/класс крепления/допуски).
- Проверку допустимости режимов (нагрузки/температуры/прочность в рамках модели).
- Выдачу читаемых диагностик (что/где/почему не так).

### 7.5 Предрасчёт физики на этапе валидации
Результат валидации — **стабильный набор производных параметров**, которые потребляет бой.
На валидации вычисляются (в выбранных приближениях):
- масса, центр масс, моменты инерции;
- нагрузки на узлы, импульсы;
- нагрев/охлаждение/теплоёмкость/теплоотдача;
- надёжность/износ (по режимам работы);
- производные показатели управляемости (штрафы AP, время наводки, утомление и т.п.).

---

## 8. Табличные модели воздействия
**Принцип:** тяжёлые вычисления — оффлайн; в бою — **lookup/интерполяция**.

Система не ограничена огнестрелом. Любая сборка может содержать разные **эффекторы** и **защитные/утилитарные подсистемы**.

### 8.1 Эффекторы
Для каждого типа эффектора определяется предрасчётная модель и набор профилей/таблиц:
- кинетический носитель (пуля/болт/осколок);
- луч/энергетика;
- ближний бой;
- взрыв/осколки (не v0.1, см. ниже);
- гибриды (композиция каналов).

### 8.2 Защита и экипировка
Защита задаётся профилями сопротивления/деградации и влиянием на носителя/персонажа:
- сопротивление угрозам по каналам;
- покрытие зон/уязвимости стыков;
- штрафы/бонусы к подвижности, AP, заметности, теплообмену.

### 8.3 Окружение как материальные барьеры + распространение
Окружение (стены, укрытия, грунт, стекло) рассматривается тем же механизмом, что и защита:
- объект окружения = геометрия + стек слоёв материала;
- контакт создаёт событие воздействия; барьер трансформирует воздействие и возвращает остаток.

---

## 9. Контракт воздействия: Impact Packet и Threat Model
### 9.1 Пакет воздействия и модель угроз
- **Impact Packet** — описание *акта взаимодействия* (контакт/поражение) в терминах модели.
- **Threat Model** — перечень поддерживаемых каналов угроз и операторов преобразования для защиты/барьеров.

### 9.2 Impact Packet (общий контракт)
Impact Packet — **immutable record** в согласованных единицах (по умолчанию SI).
Минимальный заголовок:
- `schema_version`, `packet_id`, `source_id`, `timestamp/step`, `channels[]`, `target_zone` (если известна), `rng_seed_ref`.

Минимальное физическое содержание:
- геометрия контакта (точка/нормаль/площадь/угол),
- кинематика (вектор скорости/направление, масса/эквивалентная масса),
- инварианты канала (энергия/импульс/плотности потоков и т.п.).

Неопределённость/вариативность задаётся явно (`tolerances`/распределения/ковариации) и реализуется детерминированно через seed.

### 9.3 Threat Model и слои защиты
Каждый слой защиты/барьер предоставляет оператор:
`F_layer(packet, state, env) -> packet_residual + effects`
где `state` включает нагрев/повреждение/износ, `env` — параметры среды. Реализация — формулы или lookup-таблицы.

### 9.4 Effects (выходы)
Effects фиксируют режимы и изменения:
- режим: `stop | penetrate | ricochet`;
- остаточные параметры воздействия (скорость/энергия/импульс/угол);
- повреждение барьера/брони;
- вторичные носители (если модель позволяет).

---

## 10. Carrier State и распространение в пространстве
Impact Packet описывает **контакт**, но не «закон движения». Для перемещения воздействия между контактами вводится:

- **Carrier State** — состояние носителя воздействия (пуля/луч/волна) между взаимодействиями.

Carrier State минимально включает:
- `propagation_profile_id`, позицию/направление;
- скорость/энергию (или эквивалентные инварианты);
- параметры, критичные для профиля (например, для пули: масса/форма/спин; для луча: мощность/расходимость).

Распространение задаётся оператором:
`G(state, medium_segment, env) -> state'`
и реализуется через предрасчитанные таблицы/аппроксимации.

При пересечении геометрии барьера выполняется переход:
`state -> Impact Packet -> F_layer(...) -> state_residual` (при пробое — продолжение пути).

---

## 11. Барьеры окружения: геометрия, слои, transfer function
### 11.1 Представление барьера
- `shape` (геометрия для пересечений)
- `layers[]` (материал + толщина + ориентация/анизотропия при необходимости)
- `state` (повреждение/температура/иное)

### 11.2 Эффективная толщина и режим контакта
При пересечении определяются:
- эффективная толщина по направлению движения (учёт угла),
- режим контакта (вход/выход/скольжение),
- `path_length_in_layer` для каждого слоя.

### 11.3 Transfer function H
Ответ барьера задаётся функцией переноса:
`H(material, channel, incident_params, state, env) -> residual_params + effects`
Реализация — lookup/аппроксимации.

Для кинетики покрываются режимы:
- непробитие,
- пробой,
- рикошет,
- фрагментация (генерация вторичных носителей).

Повреждение накапливается и влияет на последующие ответы (в т.ч. «качество укрытия»).

Для производительности допускается LOD представления окружения, при неизменном контракте `shape + layers + H`.

---

## 12. Библиотека материалов
### 12.1 Принцип
Библиотека материалов **единая** для оружия, брони, снаряжения и окружения.

### 12.2 MaterialDefinition
Материал хранит **параметры** и **законы (material laws)**, а «решения» для боя задаются таблицами/поверхностями отклика.

`MaterialDefinition v0.1`:
- служебные: `material_id`, `display_name`, `family`, `tags`, `references` (опц.), `schema_version`;
- механика (SI): `rho`, `E`, `nu`, `sigma_y` (если применимо), `sigma_u` (опц.), `H` (с типом шкалы), `K_IC` (опц.), `eta` (опц.);
- термо: `c_p`, `k`, `T_deg` (для полимеров/композитов), `T_m` (если применимо), `L_m` (опц.), `epsilon` (опц.);
- контакт: `mu` (профили/условия), опц. адгезия/шероховатость;
- электро/EMP (по необходимости): `sigma_e`, `eps_r`, `E_break` (опц.), `mu_r` (опц.).

Допускаются **калиброванные коэффициенты модели** (например `R_pen`, `C_imp`, `C_ablation`), но они должны быть явно помечены как model-specific и версионироваться.

### 12.3 LayerDefinition
`LayerDefinition v0.1`:
- `material_id`, `t [m]`, опц. ориентация/анизотропия/пористость;
- `damage (0..1)`, `temperature [K]` (если используется);
- опц. идентификатор интерфейса/клея между слоями.

### 12.4 Законы материала (хуки)
Материал предоставляет набор модельных операторов (LOD допускается):
- `M_mech` (деформация/пластичность/разрушение в выбранном приближении),
- `M_therm` (нагрев/теплоперенос/абляция),
- `M_wave` (упрощённое распространение импульса/ударных волн),
- `M_em` (экранирование/затухание/пробой),
- `M_surface` (контакт/трение).

### 12.5 Предрасчитанные таблицы (response surfaces)
Минимальный набор для прототипа:
- `H_penetration(material, thickness, angle, v_in, m, d, shape) -> v_out / stop`
- `H_ricochet(material, angle, v_in, surface_state) -> P(ricochet), angle_out, v_out`
- `H_spall_fragment(...) -> fragments_profile` (опц. v0.1)

Для целей (зоны/конструкции):
- `penetration_depth`, `impulse_transmitted`, `blunt_trauma_index`, термо-метрики (`thermal_dose`/`delta_T`).

Для распространения (Carrier State):
- `G_drag(profile_id, v, medium_params) -> dv/dx` или lookup `v(x)`.

### 12.6 Версионирование
Материалы, модели и таблицы версионируются вместе (`material_schema_version`/`model_version`). Любое изменение → пересборка таблиц и обновление golden-тестов.

---

## 13. Threat Model v0.1 (каналы)
`Threat Model v0.1` включает два канала:
1) **Кинетика/проникновение**
2) **Термо**

Фрагментация/осколки в v0.1 — частный случай кинетики (генерация дополнительных носителей), без отдельной модели взрыва/давления/EM.

### 13.1 Поля кинетического канала (Impact Packet)
- `v_vec [m/s]`, `m_eff [kg]`, `d_eq [m]`, `shape_id`, `incidence_angle [rad]`, `contact_area [m^2]`, `E [J]`, `p_vec [N*s]`
- опц.: `yaw [rad]`, `spin [rad/s]`, `penetrator_material_id`

### 13.2 Поля термо канала (Impact Packet)
- `q_dot [W]` или `q_flux [W/m^2]`, `spot_area [m^2]`, `exposure_dt [s]`, `T_source [K]`
- опц.: `spectrum_id`/`mode_id`

### 13.3 Минимальные effects v0.1
- для барьеров/брони: режим, `v_out/E_out/p_out`, `angle_out`, `damage_delta`, опц. `hole_diameter`, `spall_profile_id`;
- для цели: `penetration_depth`, `E_deposited`, `impulse_transmitted`, `blunt_trauma_index`, `thermal_dose` или `delta_T`.

### 13.4 Lookup и детерминизм
Правила интерполяции/квантования и политика clamp/extrapolation — часть модели и входят в golden-тесты.

Если канал не поддержан объектом, поведение задаётся явной политикой модели (пропуск/поглощение/ошибка валидации) и тестируется.

---

## 14. Пошаговый бой (использует результаты предрасчёта)
### 14.1 Общие принципы
- Бой потребляет только **производные параметры** из валидатора и **табличные модели**.
- Никаких тяжёлых интеграторов в боевом тике.

### 14.2 Экономика действий
- **AP**: движение, смена стойки, применение эффектора, перезарядка/переключение, утилита.
- (Опционально) реакция/overwatch.

### 14.3 Взаимодействие с окружением
- укрытия — это барьеры с геометрией и слоями;
- попадание/пробой/рикошет/повреждение укрытий следует через `Carrier State -> Impact Packet -> H/F_layer`.

---

## 15. Баланс и ограничения

### 15.1 Подход
Баланс строится на **комбинации физических trade-off'ов и экономических ограничений**. Физика создаёт естественные компромиссы (тяжелее = медленнее, мощнее = горячее), экономика не позволяет игнорировать их за счёт ресурсов.

Нет единственного «лучшего» решения — есть решения, оптимальные для конкретной задачи, среды и бюджета.

### 15.2 Физические ограничения (естественные trade-off'ы)

**Масса и подвижность.** Масса сборки напрямую влияет на AP, скорость перемещения, утомление бойца, время наводки. Тяжёлая броня защищает лучше, но ограничивает тактические возможности в бою. Тяжёлое оружие бьёт сильнее, но требует больше AP на применение и смену позиции.

**Энергия.** Энергоёмкие системы (энергетическое оружие, активная защита, сенсоры, экзоскелеты) конкурируют за ограниченный бюджет энергии. Мощный лазер может оставить бойца без питания для стабилизации или активной брони. Энергобюджет задаётся источниками/накопителями в сборке.

**Износ и надёжность.** Мощные/экстремальные режимы работы ускоряют износ. Высокоскоростной ствол деградирует быстрее; тонкая броня, работающая на пределе, теряет свойства после нескольких попаданий. Износ накапливается между боями и требует ремонта/замены.

**Нагрев.** Мощные эффекторы генерируют больше тепла; перегрев снижает точность, ускоряет износ, может привести к отказу. Охлаждение добавляет массу и объём. Термобюджет — ещё одно измерение компромисса.

### 15.3 Экономические ограничения

**Стоимость и редкость.** Продвинутые материалы и модули стоят дороже и/или встречаются реже. Игрок не может просто поставить лучшее во все слоты — бюджет ограничен. Это вынуждает выбирать: усилить оружие или защиту, вложиться в одного бойца или распределить ресурсы на отряд.

**Ремонт и расходники.** Мощное снаряжение дороже в обслуживании. Боеприпасы, запчасти, энергоячейки — расходуются и требуют пополнения. Экономически невыгодно использовать дорогие боеприпасы на слабые цели.

### 15.4 Связь с прогрессией
На низких техуровнях ограничения жёсткие: мало энергии, тяжёлые материалы, быстрый износ. С ростом технологий ограничения смещаются, а не исчезают — композиты легче, но требуют редких ресурсов; энергетическое оружие не имеет боеприпасов, но жрёт энергию и перегревается.

---

## 16. Данные, тесты и воспроизводимость
- Логика расчётов вынесена в **ядро симуляции** (без движка).
- Тесты: unit + golden + (по мере зрелости) property-based.
- Стохастика — только с детерминированными seed и фиксированными правилами.

### 16.1 Units & Conventions
Все данные и таблицы — в канонических единицах (SI). Импорт из иных единиц возможен только через явное преобразование и тесты.

---

## 17. Минимальный прототип (этапы)

### 17.1 Slice 0 — Proof of Pipeline
Цель: доказать, что пайплайн «сборка → валидация → предрасчёт → воздействие → результат» работает от начала до конца.
- Один кинетический носитель (пуля с фиксированными параметрами).
- Одна пластина-барьер (один материал, одна толщина).
- Валидация + генерация минимальной таблицы `H_penetration`.
- Текстовый вывод результата: пробитие/остановка/рикошет, остаточные параметры.
- Детерминированный seed, golden-тест на результат.

### 17.2 Slice 1 — Сборка и взаимодействие
Цель: проверить полный цикл конструктора и механики взаимодействия оружия с защитой.
- Простейшая, но **полная сборка оружия** (все обязательные компоненты: ствол, затвор/механизм, приклад/рукоять, боеприпас — минимальные варианты).
- Простейшая **сборка брони** (несколько слоёв, минимум 2 материала).
- Серия выстрелов (не один) — проверка:
  - взаимодействия оружие → броня через Impact Packet;
  - механики **деградации** (износ ствола, повреждение брони при повторных попаданиях);
  - **стохастики** (разброс, seed, воспроизводимость);
  - нагрева и его влияния на последующие выстрелы.
- Валидация обеих сборок, генерация таблиц `H` и `G`.
- Текстовый/табличный вывод: лог каждого выстрела, итоговое состояние оружия и брони.

### 17.3 Slice 2 — Playable Prototype
Цель: первый играбельный прототип с тактическим боем.
- Набор материалов v0.1 (металл/дерево/бетон/стекло/грунт + базовые композиты).
- 1–2 класса эффекторов (кинетика + простой термо-источник).
- Тактическая арена с примитивными укрытиями (геометрия + слои).
- Пошаговый бой с AP, пробоем укрытий и базовыми эффектами по зоне.
- Post-battle отчёт (уровень 2 обратной связи, см. раздел 6.3).

### 17.4 Slice 3 — Vertical Slice
Цель: полноценный вертикальный срез игрового опыта — от конструктора до долгосрочной петли.
- Несколько последовательных боёв с нарастающей сложностью (разные противники, среды, дистанции).
- Технологическая прогрессия между боями: открытие новых модулей/материалов, раскрытие новых вкладок параметров (см. раздел 5.1).
- Полноценный post-battle отчёт с привязкой событий к модулям сборки.
- Износ/ремонт/расходники между боями — игрок вынужден пересобирать или чинить снаряжение.
- Демонстрация петли мотивации (см. раздел 6.2): бой → анализ → конструктор → бой с улучшенной сборкой.

---

## 18. Дизайн-аксиомы (кратко)
- Тяжёлые вычисления — до боя; бой — lookup.
- «Модуль» = Part; функциональность — Components.
- Причинно-следственная связь может быть нелинейной; объяснения — агрегировано и честно.
- Окружение = такие же материальные барьеры, как броня.
- Единая библиотека материалов + версионирование модели/таблиц/тестов.

